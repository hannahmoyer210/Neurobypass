---
title: "prevelance"
output: word_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r pfs_mas, echo=FALSE, results='hide', warning=FALSE, include=FALSE}
library(readr)
library(ggplot2)
library(meta)
library(forestplot)
library(stringr)
library(readxl)
library(tidyverse)
library(rstatix)

```


```{r, echo=FALSE, message = FALSE, warning=FALSE, include=FALSE}
#for prevalance table 
neurobypass <- read_csv("cleancodeR2.csv")
forrange<-neurobypass$enrollment 
summary(neurobypass$enrollment)
IQR(forrange) 

#total overall
Totalcount <-nrow(neurobypass)

Totalpreceededsubset<-subset(neurobypass, preceeded == "1")
TotalNPsubset<-subset(neurobypass, Nonpositive == "1")
TotalBEsubset<-subset(neurobypass, bad_endpoint == "1")
Totalbypasssubset<-subset(neurobypass, Truebypass == "1")
  
Totalpreceededcount<-nrow(Totalpreceededsubset)
TotalNPcount<-nrow(TotalNPsubset)
TotalBEcount<-nrow(TotalBEsubset)
Totalbypasscount<-nrow(Totalbypasssubset)

Totalpreceededpercent <- (divide_by(Totalpreceededcount,Totalcount))*100
TotalNPpercent <- (divide_by(TotalNPcount,Totalcount))*100
TotalBEpercent <- (divide_by(TotalBEcount,Totalcount))*100
Totalbypasspercent <- (divide_by(Totalbypasscount,Totalcount))*100

#subsets
ADsubset <- subset(neurobypass, indication == "AD")
PDsubset <- subset(neurobypass, indication == "PD")
ALSsubset <- subset(neurobypass, indication == "ALS")
HDsubset <- subset(neurobypass, indication == "Huntingtons")
RMSsubset <- subset(neurobypass, indication == "RMS")
PMSsubset <- subset(neurobypass, indication == "PMS")
Headachesubset <- subset(neurobypass, indication == "Headache")
Epilepsysubset <- subset(neurobypass, indication == "Epilepsy")
TBIsubset <- subset(neurobypass, indication == "TBI")
Strokesubset <- subset(neurobypass, indication == "Stroke")

#totalcount
ADcount <- nrow(ADsubset)
PDcount <- nrow(PDsubset)
ALScount <- nrow(ALSsubset)
HDcount <- nrow(HDsubset)
RMScount <- nrow(RMSsubset)
PMScount <- nrow(PMSsubset)
Headachecount <- nrow(Headachesubset)
Epilepsycount <- nrow(Epilepsysubset)
TBIcount <- nrow(TBIsubset)
Strokecount <- nrow(Strokesubset)

#precededsubset
ADpreceeded <- subset(ADsubset, preceeded == "1")
PDpreceeded<- subset(PDsubset, preceeded == "1")
ALSpreceeded <- subset(ALSsubset, preceeded == "1")
HDpreceeded <- subset(HDsubset, preceeded == "1")
RMSpreceeded <- subset(RMSsubset, preceeded == "1")
PMSpreceeded <- subset(PMSsubset, preceeded == "1")
Headachepreceeded <- subset(Headachesubset, preceeded == "1")
Epilepsypreceeded <- subset(Epilepsysubset, preceeded == "1")
TBIpreceeded <- subset(TBIsubset, preceeded == "1")
Strokepreceeded <- subset(Strokesubset, preceeded == "1")

#precededcount
ADpreceededcount <- nrow(ADpreceeded)
PDpreceededcount <- nrow(PDpreceeded)
ALSpreceededcount <- nrow(ALSpreceeded)
HDpreceededcount <- nrow(HDpreceeded)
RMSpreceededcount <- nrow(RMSpreceeded)
PMSpreceededcount <- nrow(PMSpreceeded)
Headachepreceededcount <- nrow(Headachepreceeded)
Epilepsypreceededcount <- nrow(Epilepsypreceeded)
TBIpreceededcount <- nrow(TBIpreceeded)
Strokepreceededcount <- nrow(Strokepreceeded)

#precededpercent
ADpcdpercent <- (divide_by(ADpreceededcount,ADcount))*100
PDpcdpercent <- (divide_by(PDpreceededcount,PDcount))*100
ALSpcdpercent <- (divide_by(ALSpreceededcount,ALScount))*100
HDpcdpercent <- (divide_by(HDpreceededcount,HDcount))*100
RMSpcdpercent <- (divide_by(RMSpreceededcount,RMScount))*100
PMSpcdpercent <-(divide_by(PMSpreceededcount,PMScount))*100
Headachepcdpercent <- (divide_by(Headachepreceededcount,Headachecount))*100
Epilepsypcdpercent <- (divide_by(Epilepsypreceededcount,Epilepsycount))*100
TBIpcdpercent <- (divide_by(TBIpreceededcount,TBIcount))*100
Strokepcdpercent <- (divide_by(Strokepreceededcount,Strokecount))*100
#bypass is opposite percent

#ambig NP 
ADpreceededambi <- subset(ADsubset, Nonpositive == "1")
PDpreceededambi<- subset(PDsubset, Nonpositive == "1")
ALSpreceededambi <- subset(ALSsubset, Nonpositive == "1")
HDpreceededambi <- subset(HDsubset, Nonpositive == "1")
RMSpreceededambi <- subset(RMSsubset, Nonpositive == "1")
PMSpreceededambi <- subset(PMSsubset, Nonpositive == "1")
Headachepreceededambi <- subset(Headachesubset, Nonpositive == "1")
Epilepsypreceededambi <- subset(Epilepsysubset, Nonpositive == "1")
TBIpreceededambi <- subset(TBIsubset, Nonpositive == "1")
Strokepreceededambi <- subset(Strokesubset, Nonpositive == "1")

#Ambicount NP
ADpreceededcountambi <- nrow(ADpreceededambi)
PDpreceededcountambi <- nrow(PDpreceededambi)
ALSpreceededcountambi <- nrow(ALSpreceededambi)
HDpreceededcountambi <- nrow(HDpreceededambi)
RMSpreceededcountambi <- nrow(RMSpreceededambi)
PMSpreceededcountambi <- nrow(PMSpreceededambi)
Headachepreceededcountambi <- nrow(Headachepreceededambi)
Epilepsypreceededcountambi <- nrow(Epilepsypreceededambi)
TBIpreceededcountambi <- nrow(TBIpreceededambi)
Strokepreceededcountambi <- nrow(Strokepreceededambi)

#ambipercent NP
ADpcdpercentambi <- (divide_by(ADpreceededcountambi,ADcount))*100
PDpcdpercentambi <- (divide_by(PDpreceededcountambi,PDcount))*100
ALSpcdpercentambi <- (divide_by(ALSpreceededcountambi,ALScount))*100
HDpcdpercentambi <- (divide_by(HDpreceededcountambi,HDcount))*100
RMSpcdpercentambi <- (divide_by(RMSpreceededcountambi,RMScount))*100
PMSpcdpercentambi <-(divide_by(PMSpreceededcountambi,PMScount))*100
Headachepcdpercentambi <- (divide_by(Headachepreceededcountambi,Headachecount))*100
Epilepsypcdpercentambi <- (divide_by(Epilepsypreceededcountambi,Epilepsycount))*100
TBIpcdpercentambi <- (divide_by(TBIpreceededcountambi,TBIcount))*100
Strokepcdpercentambi <- (divide_by(Strokepreceededcountambi,Strokecount))*100

#ambig BE
ADpreceededbeambi <- subset(ADsubset, bad_endpoint == "1")
PDpreceededbeambi<- subset(PDsubset, bad_endpoint == "1")
ALSpreceededbeambi <- subset(ALSsubset, bad_endpoint == "1")
HDpreceededbeambi <- subset(HDsubset, bad_endpoint == "1")
RMSpreceededbeambi <- subset(RMSsubset, bad_endpoint == "1")
PMSpreceededbeambi <- subset(PMSsubset, bad_endpoint == "1")
Headachepreceededbeambi <- subset(Headachesubset, bad_endpoint == "1")
Epilepsypreceededbeambi <- subset(Epilepsysubset, bad_endpoint == "1")
TBIpreceededbeambi <- subset(TBIsubset, bad_endpoint == "1")
Strokepreceededbeambi <- subset(Strokesubset, bad_endpoint == "1")

#Ambicount BE
ADpreceededcountbeambi <- nrow(ADpreceededbeambi)
PDpreceededcountbeambi <- nrow(PDpreceededbeambi)
ALSpreceededcountbeambi <- nrow(ALSpreceededbeambi)
HDpreceededcountbeambi <- nrow(HDpreceededbeambi)
RMSpreceededcountbeambi <- nrow(RMSpreceededbeambi)
PMSpreceededcountbeambi <- nrow(PMSpreceededbeambi)
Headachepreceededcountbeambi <- nrow(Headachepreceededbeambi)
Epilepsypreceededcountbeambi <- nrow(Epilepsypreceededbeambi)
TBIpreceededcountbeambi <- nrow(TBIpreceededbeambi)
Strokepreceededcountbeambi <- nrow(Strokepreceededbeambi)

#ambipercent BE
ADpcdpercentbeambi <- (divide_by(ADpreceededcountbeambi,ADcount))*100
PDpcdpercentbeambi <- (divide_by(PDpreceededcountbeambi,PDcount))*100
ALSpcdpercentbeambi <- (divide_by(ALSpreceededcountbeambi,ALScount))*100
HDpcdpercentbeambi <- (divide_by(HDpreceededcountbeambi,HDcount))*100
RMSpcdpercentbeambi <- (divide_by(RMSpreceededcountbeambi,RMScount))*100
PMSpcdpercentbeambi <-(divide_by(PMSpreceededcountbeambi,PMScount))*100
Headachepcdpercentbeambi <- (divide_by(Headachepreceededcountbeambi,Headachecount))*100
Epilepsypcdpercentbeambi <- (divide_by(Epilepsypreceededcountbeambi,Epilepsycount))*100
TBIpcdpercentbeambi <- (divide_by(TBIpreceededcountbeambi,TBIcount))*100
Strokepcdpercentbeambi <- (divide_by(Strokepreceededcountbeambi,Strokecount))*100

#Bypasstruenumber 
ADbypass <- subset(ADsubset, Truebypass == "1")
PDbypass<- subset(PDsubset, Truebypass == "1")
ALSbypass <- subset(ALSsubset, Truebypass == "1")
HDbypass <- subset(HDsubset, Truebypass == "1")
RMSbypass <- subset(RMSsubset, Truebypass == "1")
PMSbypass <- subset(PMSsubset, Truebypass == "1")
Headachebypass <- subset(Headachesubset, Truebypass == "1")
Epilepsybypass <- subset(Epilepsysubset, Truebypass == "1")
TBIbypass <- subset(TBIsubset, Truebypass == "1")
Strokebypass <- subset(Strokesubset, Truebypass == "1")

ADtruebpnumber <- nrow(ADbypass)
PDtruebpnumber <- nrow(PDbypass)
ALStruebpnumber <- nrow(ALSbypass)
HDtruebpnumber <- nrow(HDbypass)
RMStruebpnumber <- nrow(RMSbypass)
PMStruebpnumber <- nrow(PMSbypass)
Headachetruebpnumber <- nrow(Headachebypass)
Epilepsytruebpnumber <- nrow(Epilepsybypass)
TBItruebpnumber <- nrow(TBIbypass)
Stroketruebpnumber <- nrow(Strokebypass)

#Bypasstruepercent 

ADtruebppercent <- (divide_by(ADtruebpnumber,ADcount))*100
PDtruebppercent <- (divide_by(PDtruebpnumber,PDcount))*100
ALStruebppercent <- (divide_by(ALStruebpnumber,ALScount))*100
HDtruebppercent <- (divide_by(HDtruebpnumber,HDcount))*100
RMStruebpdpercent <- (divide_by(RMStruebpnumber,RMScount))*100
PMStruebppercent <- (divide_by(PMStruebpnumber,PMScount))*100
Headachetruebppercent <- (divide_by(Headachetruebpnumber,Headachecount))*100
Epilepsytruebppercent <- (divide_by(Epilepsytruebpnumber,Epilepsycount))*100
TBItruebppercent <- (divide_by(TBItruebpnumber,TBIcount))*100
Stroketruebppercent <- (divide_by(Stroketruebpnumber,Strokecount))*100

Indicationvector1<-c("All indications", "Alzheimer's disease","Parkinson's disease","Amyotrophic lateral sclerosis","Huntington's disease","Relapsing Multiple sclerosis","Progressive Multiple sclerosis","Headache","Epilepsy","TBI","Stroke")

NumberofTrials<- c(Totalcount, ADcount, PDcount, ALScount, HDcount, RMScount, PMScount, Headachecount, Epilepsycount, TBIcount, Strokecount)

PreceededNumber<- c(Totalpreceededcount,ADpreceededcount,PDpreceededcount,ALSpreceededcount,HDpreceededcount,RMSpreceededcount,PMSpreceededcount,Headachepreceededcount,Epilepsypreceededcount,TBIpreceededcount, Strokepreceededcount)

PreceededRate<- c(Totalpreceededpercent, ADpcdpercent, PDpcdpercent, ALSpcdpercent, HDpcdpercent, RMSpcdpercent, PMSpcdpercent, Headachepcdpercent, Epilepsypcdpercent,TBIpcdpercent, Strokepcdpercent)

AmbiNonposNumber <- c(TotalNPcount,ADpreceededcountambi,PDpreceededcountambi,ALSpreceededcountambi,HDpreceededcountambi,RMSpreceededcountambi,PMSpreceededcountambi,Headachepreceededcountambi,Epilepsypreceededcountambi,TBIpreceededcountambi,Strokepreceededcountambi)

PreceededNonposRate <- c(TotalNPpercent,ADpcdpercentambi,PDpcdpercentambi,ALSpcdpercentambi,HDpcdpercentambi,RMSpcdpercentambi,PMSpcdpercentambi,Headachepcdpercentambi,Epilepsypcdpercentambi,TBIpcdpercentambi,Strokepcdpercentambi)

AmbiBENumber <- c(TotalBEcount,ADpreceededcountbeambi,PDpreceededcountbeambi,ALSpreceededcountbeambi,HDpreceededcountbeambi,RMSpreceededcountbeambi,PMSpreceededcountbeambi,Headachepreceededcountbeambi,Epilepsypreceededcountbeambi,TBIpreceededcountbeambi,Strokepreceededcountbeambi)

PreceededBERate <- c(TotalBEpercent,ADpcdpercentbeambi,PDpcdpercentbeambi,ALSpcdpercentbeambi,HDpcdpercentbeambi,RMSpcdpercentbeambi,PMSpcdpercentbeambi,Headachepcdpercentbeambi,Epilepsypcdpercentbeambi,TBIpcdpercentbeambi,Strokepcdpercentbeambi)

Bypasstruenumber <- c(Totalbypasscount,ADtruebpnumber, PDtruebpnumber, ALStruebpnumber, HDtruebpnumber, RMStruebpnumber, PMStruebpnumber, Headachetruebpnumber, Epilepsytruebpnumber, TBItruebpnumber, Stroketruebpnumber)

Bypasstruepercent <- c(Totalbypasspercent, ADtruebppercent, PDtruebppercent, ALStruebppercent, HDtruebppercent, RMStruebpdpercent,PMStruebppercent, Headachetruebppercent, Epilepsytruebppercent, TBItruebppercent, Stroketruebppercent)

prevelance <- data.frame(Indication=rep(Indicationvector1),
                 Number_of_P3_Trials=rep(NumberofTrials),
                 PreceededNumber=rep(PreceededNumber),
                 PreceededRate=rep(PreceededRate),
                 NonposNumber=rep(AmbiNonposNumber),
                 NonposRate=rep(PreceededNonposRate),
                 BENumber=rep(AmbiBENumber),
                 BERate=rep(PreceededBERate),
                 Bypasstruenumber=rep(Bypasstruenumber),
                 Bypasstruepercent=rep(Bypasstruepercent)
                 )

#view head of data 
view(prevelance)
write.table(prevelance)

```

```{r, echo=FALSE, message = FALSE, warning=FALSE, include=FALSE}
#for association table
#overall
OverallIndustrysubset <- subset(neurobypass, pharmafunding == "pharma")
OverallApprovedsubset <- subset(neurobypass, approva_status == "postapproval")


OverallIndustrynumber <- nrow(OverallIndustrysubset)
OverallApprovednumber <- nrow(OverallApprovedsubset)


OverallIndustrypercent <- (divide_by(OverallIndustrynumber,Totalcount))*100
OverallApprovedpercent <- (divide_by(OverallApprovednumber,Totalcount))*100

#proceeded
Procsubset<-subset(neurobypass,preceeded=="1")
Procnumber<-nrow(Procsubset)

ProcIndustrysubset <- subset(Procsubset, pharmafunding == "pharma")
ProcApprovedsubset <- subset(Procsubset, approva_status == "postapproval")

ProcIndustrynumber <- nrow(ProcIndustrysubset)
ProcApprovednumber <- nrow(ProcApprovedsubset)

ProcIndustrypercent <- (divide_by(ProcIndustrynumber,Procnumber))*100
ProcApprovedpercent <- (divide_by(ProcApprovednumber,Procnumber))*100

#NP 
NPBypass <-subset(neurobypass,Nonpositive =="1")
NPBypassnumber <-nrow(NPBypass)

NPBypassIndustrysubset <- subset(NPBypass, pharmafunding == "pharma")
NPBypassApprovedsubset <- subset(NPBypass, approva_status == "postapproval")

NPBypassIndustrynumber <- nrow(NPBypassIndustrysubset)
NPBypassApprovednumber <- nrow(NPBypassApprovedsubset)

NPBypassIndustrypercent <- (divide_by(NPBypassIndustrynumber,NPBypassnumber))*100
NPBypassApprovedpercent <- (divide_by(NPBypassApprovednumber,NPBypassnumber))*100

#BE
BEBypass <-subset(neurobypass,bad_endpoint =="1")
BEBypassnumber <-nrow(BEBypass)

BEIndustrysubset <- subset(BEBypass, pharmafunding == "pharma")
BEApprovedsubset <- subset(BEBypass, approva_status == "postapproval")

BEIndustrynumber <- nrow(BEIndustrysubset)
BEApprovednumber <- nrow(BEApprovedsubset)

BEIndustrypercent <- (divide_by(BEIndustrynumber,BEBypassnumber))*100
BEApprovedpercent <- (divide_by(BEApprovednumber,BEBypassnumber))*100

#TB
TrueBypass <-subset(neurobypass,Truebypass =="1")
TrueBypassnumber <-nrow(TrueBypass)

TrueBypassIndustrysubset <- subset(TrueBypass, pharmafunding == "pharma")
TrueBypassApprovedsubset <- subset(TrueBypass, approva_status == "postapproval")

TrueBypassIndustrynumber <- nrow(TrueBypassIndustrysubset)
TrueBypassApprovednumber <- nrow(TrueBypassApprovedsubset)

TrueBypassIndustrypercent <- (divide_by(TrueBypassIndustrynumber,TrueBypassnumber))*100
TrueBypassApprovedpercent <- (divide_by(TrueBypassApprovednumber,TrueBypassnumber))*100

#fisher

industryfisher <- fisher.test(table(neurobypass$pharmafunding, neurobypass$preceeded))
approvedfisher <- fisher.test(table(neurobypass$approva_status, neurobypass$preceeded))

industrypvalue <- industryfisher$p.value
approvalpvalue <- approvedfisher$p.value

Names<-c("Pharma funded","Approved")
OverallNs<-c(OverallIndustrynumber,OverallApprovednumber)
Overallsecondaries<-c(OverallIndustrypercent,OverallApprovedpercent)
Proceededsecondaries<-c(ProcIndustrynumber,ProcApprovednumber)
Proceededsecondariespercent<-c(ProcIndustrypercent,ProcApprovedpercent)
NPbypasssecondaries<-c(NPBypassIndustrynumber,NPBypassApprovednumber)
NPbypasssecondariespercent<-c(NPBypassIndustrypercent,NPBypassApprovedpercent)
BEbypasssecondaries<-c(BEIndustrynumber,BEApprovednumber)
BEbypasssecondariespercent<-c(BEIndustrypercent,BEApprovedpercent)
Truebypasssecondaries<-c(TrueBypassIndustrynumber,TrueBypassApprovednumber)
Truebypasssecondariespercent<-c(TrueBypassIndustrypercent,TrueBypassApprovedpercent)
Pvaluessecondaries<-c(industrypvalue,approvalpvalue)

secondariestable <- data.frame(Secondary=rep(Names),
                AllN=rep(OverallNs),          
                All_percent=rep(Overallsecondaries),
                PrecededN=rep(Proceededsecondaries),
                Precededpercent=rep(Proceededsecondariespercent),
                NPBypassN=rep(NPbypasssecondaries),
                NPBypasspercent=rep(NPbypasssecondariespercent),
                BEBypassN=rep(BEbypasssecondaries),
                BEBypasspercent=rep(BEbypasssecondariespercent),
                TrueBypassN=rep(Truebypasssecondaries),
                TrueBypasspercent=rep(Truebypasssecondariespercent),
                pvalues=rep(Pvaluessecondaries)
                 )

print(secondariestable)
write.table(secondariestable)


```
 

```{r, echo=FALSE, message = FALSE, warning=FALSE, include=FALSE}

#for positivity
##need subset with results for denominators
Overallhasresults <- subset(neurobypass, results_available  == "1")
ADhasresults <- subset(ADsubset, results_available  == "1")
PDhasresults <- subset(PDsubset, results_available  == "1")
ALShasresults <- subset(ALSsubset, results_available  == "1")
HDhasresults <- subset(HDsubset, results_available  == "1")
RMShasresults <- subset(RMSsubset, results_available  == "1")
PMShasresults <- subset(PMSsubset, results_available  == "1")
Headachehasresults <- subset(Headachesubset, results_available  == "1")
Epilepsyhasresults <- subset(Epilepsysubset, results_available  == "1")
TBIhasresults <- subset(TBIsubset, results_available  == "1")
Strokehasresults <- subset(Strokesubset, results_available  == "1")

Overallresultscount <- nrow(Overallhasresults)
ADresultscount <- nrow(ADhasresults)
PDresultscount <- nrow(PDhasresults)
ALSresultscount <- nrow(ALShasresults)
HDresultscount <- nrow(HDhasresults)
RMSresultscount <- nrow(RMShasresults)
PMSresultscount <- nrow(PMShasresults)
Headacheresultscount <- nrow(Headachehasresults)
Epilepsyresultscount <- nrow(Epilepsyhasresults)
TBIresultscount <- nrow(TBIhasresults)
Strokeresultscount <- nrow(Strokehasresults)

#AllP2STATUS
Overallpossubset <- subset(neurobypass, positivityofP3 == "Positive")
ADpossubset <- subset(ADsubset, positivityofP3 == "Positive")
PDpossubset <- subset(PDsubset, positivityofP3 == "Positive")
ALSpossubset <- subset(ALSsubset, positivityofP3 == "Positive")
HDpossubset <- subset(HDsubset, positivityofP3 == "Positive")
RMSpossubset <- subset(RMSsubset, positivityofP3 == "Positive")
PMSpossubset <- subset(PMSsubset, positivityofP3 == "Positive")
Headachepossubset <- subset(Headachesubset, positivityofP3 == "Positive")
Epilepsypossubset <- subset(Epilepsysubset, positivityofP3 == "Positive")
TBIpossubset <- subset(TBIsubset, positivityofP3 == "Positive")
Strokepossubset <- subset(Strokesubset, positivityofP3 == "Positive")

#poscount
Overallposcount <- nrow(Overallpossubset)
ADposcount <- nrow(ADpossubset)
PDposcount <- nrow(PDpossubset)
ALSposcount <- nrow(ALSpossubset)
HDposcount <- nrow(HDpossubset)
RMSposcount <- nrow(RMSpossubset)
PMSposcount <- nrow(PMSpossubset)
Headacheposcount <- nrow(Headachepossubset)
Epilepsyposcount <- nrow(Epilepsypossubset)
TBIposcount <- nrow(TBIpossubset)
Strokeposcount <- nrow(Strokepossubset)

#pospercent
Overallpospercent <- (divide_by(Overallposcount,Overallresultscount))*100
ADpospercent <- (divide_by(ADposcount,ADresultscount))*100
PDpospercent <- (divide_by(PDposcount,PDresultscount))*100
ALSpospercent <- (divide_by(ALSposcount,ALSresultscount))*100
HDpospercent <- (divide_by(HDposcount,HDresultscount))*100
RMSpospercent <- (divide_by(RMSposcount,RMSresultscount))*100
PMSpospercent <-(divide_by(PMSposcount,PMSresultscount))*100
Headachepospercent <- (divide_by(Headacheposcount,Headacheresultscount))*100
Epilepsypospercent <- (divide_by(Epilepsyposcount,Epilepsyresultscount))*100
TBIpospercent <- (divide_by(TBIposcount,TBIresultscount))*100
Strokepospercent <- (divide_by(Strokeposcount,Strokeresultscount))*100

Overallpreceednew <- subset(Overallhasresults, preceeded == "1")
Overallpreceedcountnew <- nrow(Overallpreceednew)

Overallprecedposnew <- subset(Overallpreceednew, positivityofP3 == "Positive")
Overallprecposnumbernew <-nrow(Overallprecedposnew)
Overallprecedpospercentnew <- (divide_by(Overallprecposnumbernew,Overallpreceedcountnew))*100

#PROCEEDED
#proceededpos
Overallpreceed <- subset(Overallhasresults, preceeded == "1")
ADpreceed <- subset(ADhasresults, preceeded == "1")
PDpreceed<- subset(PDhasresults, preceeded == "1")
ALSpreceed <- subset(ALShasresults, preceeded == "1")
HDpreceed <- subset(HDhasresults, preceeded == "1")
RMSpreceed <- subset(RMShasresults, preceeded == "1")
PMSpreceed <- subset(PMShasresults, preceeded == "1")
Headachepreceed <- subset(Headachehasresults, preceeded == "1")
Epilepsypreceed <- subset(Epilepsyhasresults, preceeded == "1")
TBIpreceed <- subset(TBIhasresults, preceeded == "1")
Strokepreceed <- subset(Strokehasresults, preceeded == "1")

Overallpreceedcount <- nrow(Overallpreceed)
ADpreceedcount <- nrow(ADpreceed)
PDpreceedcount <- nrow(PDpreceed)
ALSpreceedcount <- nrow(ALSpreceed)
HDpreceedcount <- nrow(HDpreceed)
RMSpreceedcount <- nrow(RMSpreceed)
PMSpreceedcount <- nrow(PMSpreceed)
Headachepreceedcount <- nrow(Headachepreceed)
Epilepsypreceedcount <- nrow(Epilepsypreceed)
TBIpreceedcount <- nrow(TBIpreceed)
Strokepreceedcount <- nrow(Strokepreceed)

Overallprecedpos <- subset(Overallpreceed, positivityofP3 == "Positive")
ADprecedpos <- subset(ADpreceed, positivityofP3 == "Positive")
PDprecedpos<- subset(PDpreceed, positivityofP3 == "Positive")
ALSprecedpos <- subset(ALSpreceed, positivityofP3 == "Positive")
HDprecedpos <- subset(HDpreceed, positivityofP3 == "Positive")
RMSprecedpos <- subset(RMSpreceed, positivityofP3 == "Positive")
PMSprecedpos <- subset(PMSpreceed, positivityofP3 == "Positive")
Headacheprecedpos <- subset(Headachepreceed, positivityofP3 == "Positive")
Epilepsyprecedpos <- subset(Epilepsypreceed, positivityofP3 == "Positive")
TBIprecedpos <- subset(TBIpreceed, positivityofP3 == "Positive")
Strokeprecedpos <- subset(Strokepreceed, positivityofP3 == "Positive")

Overallprecposnumber <-nrow(Overallprecedpos)
ADprecposnumber <- nrow(ADprecedpos)
PDprecposnumber <- nrow(PDprecedpos)
ALSprecposnumber  <- nrow(ALSprecedpos)
HDprecposnumber  <- nrow(HDprecedpos)
RMSprecposnumber  <- nrow(RMSprecedpos)
PMSprecposnumber  <- nrow(PMSprecedpos)
Headacheprecposnumber  <- nrow(Headacheprecedpos)
Epilepsyprecposnumber  <- nrow(Epilepsyprecedpos)
TBIprecposnumber  <- nrow(TBIprecedpos)
Strokeprecposnumber  <- nrow(Strokeprecedpos)

Overallprecedpospercent <- (divide_by(Overallprecposnumber,Overallpreceedcount))*100
ADprecedpospercent <- (divide_by(ADprecposnumber,ADpreceedcount))*100
PDprecedpospercent <- (divide_by(PDprecposnumber,PDpreceedcount))*100
ALSprecedpospercent  <- (divide_by(ALSprecposnumber,ALSpreceedcount))*100
HDprecedpospercent <- (divide_by(HDprecposnumber,HDpreceedcount))*100
RMSprecedpospercent <- (divide_by(RMSprecposnumber,RMSpreceedcount))*100
PMSprecedpospercent <- (divide_by(PMSprecposnumber,PMSpreceedcount))*100
Headacheprecedpospercent <- (divide_by(Headacheprecposnumber,Headachepreceedcount))*100
Epilepsyprecedpospercent <- (divide_by(Epilepsyprecposnumber,Epilepsypreceedcount))*100
TBIprecedpospercent <- (divide_by(TBIprecposnumber,TBIpreceedcount))*100
Strokeprecedpospercent  <- (divide_by(Strokeprecposnumber,Strokepreceedcount))*100


#BYPASS
Overallbypassandambi <- subset(Overallhasresults, preceeded == "0")
ADbypassandambi <- subset(ADhasresults, preceeded == "0")
PDbypassandambi<- subset(PDhasresults, preceeded == "0")
ALSbypassandambi <- subset(ALShasresults, preceeded == "0")
HDbypassandambi <- subset(HDhasresults, preceeded== "0")
RMSbypassandambi <- subset(RMShasresults, preceeded == "0")
PMSbypassandambi <- subset(PMShasresults, preceeded == "0")
Headachebypassandambi <- subset(Headachehasresults, preceeded == "0")
Epilepsybypassandambi <- subset(Epilepsyhasresults, preceeded == "0")
TBIbypassandambi <- subset(TBIhasresults, preceeded == "0")
Strokebypassandambi <- subset(Strokehasresults, preceeded == "0")

Overallbypassandambicount<- nrow(Overallbypassandambi)
ADbypassandambicount <- nrow(ADbypassandambi)
PDbypassandambicount <- nrow(PDbypassandambi)
ALSbypassandambicount <- nrow(ALSbypassandambi)
HDbypassandambicount <- nrow(HDbypassandambi)
RMSbypassandambicount <- nrow(RMSbypassandambi)
PMSbypassandambicount <- nrow(PMSbypassandambi)
Headachebypassandambicount <- nrow(Headachebypassandambi)
Epilepsybypassandambicount <- nrow(Epilepsybypassandambi)
TBIbypassandambicount <- nrow(TBIbypassandambi)
Strokebypassandambicount <- nrow(Strokebypassandambi)

Overallbypasspos <- subset(Overallbypassandambi, positivityofP3 == "Positive")
ADbypasspos <- subset(ADbypassandambi, positivityofP3 == "Positive")
PDbypasspos<- subset(PDbypassandambi, positivityofP3 == "Positive")
ALSbypasspos <- subset(ALSbypassandambi, positivityofP3 == "Positive")
HDbypasspos <- subset(HDbypassandambi, positivityofP3 == "Positive")
RMSbypasspos <- subset(RMSbypassandambi, positivityofP3 == "Positive")
PMSbypasspos <- subset(PMSbypassandambi, positivityofP3 == "Positive")
Headachebypasspos <- subset(Headachebypassandambi, positivityofP3 == "Positive")
Epilepsybypasspos <- subset(Epilepsybypassandambi, positivityofP3 == "Positive")
TBIbypasspos <- subset(TBIbypassandambi, positivityofP3 == "Positive")
Strokebypasspos <- subset(Strokebypassandambi, positivityofP3 == "Positive")

Overallbypassposnumber <- nrow(Overallbypasspos)
ADbypassposnumber <- nrow(ADbypasspos)
PDbypassposnumber <- nrow(PDbypasspos)
ALSbypassposnumber  <- nrow(ALSbypasspos)
HDbypassposnumber  <- nrow(HDbypasspos)
RMSbypassposnumber  <- nrow(RMSbypasspos)
PMSbypassposnumber  <- nrow(PMSbypasspos)
Headachebypassposnumber  <- nrow(Headachebypasspos)
Epilepsybypassposnumber  <- nrow(Epilepsybypasspos)
TBIbypassposnumber  <- nrow(TBIbypasspos)
Strokebypassposnumber  <- nrow(Strokebypasspos)

Overallbypasspospercent <-(divide_by(Overallbypassposnumber,Overallbypassandambicount))*100
ADbypasspospercent <- (divide_by(ADbypassposnumber,ADbypassandambicount))*100
PDbypasspospercent <- (divide_by(PDbypassposnumber,PDbypassandambicount))*100
ALSbypasspospercent  <- (divide_by(ALSbypassposnumber,ALSbypassandambicount))*100
HDbypasspospercent <- (divide_by(HDbypassposnumber,HDbypassandambicount))*100
RMSbypasspospercent <- (divide_by(RMSbypassposnumber,RMSbypassandambicount))*100
PMSbypasspospercent <- (divide_by(PMSbypassposnumber,PMSbypassandambicount))*100
Headachebypasspospercent <- (divide_by(Headachebypassposnumber,Headachebypassandambicount))*100
Epilepsybypasspospercent <- (divide_by(Epilepsybypassposnumber,Epilepsybypassandambicount))*100
TBIbypasspospercent <- (divide_by(TBIbypassposnumber,TBIbypassandambicount))*100
Strokebypassposnumber  <- (divide_by(Strokebypassposnumber,Strokebypassandambicount))*100

#TERMINATION
#all indications term
Overalltermsubset <- subset(neurobypass, terminationcode == "1")
ADtermsubset <- subset(ADsubset, terminationcode == "1")
PDtermsubset <- subset(PDsubset,terminationcode == "1")
ALStermsubset <- subset(ALSsubset, terminationcode == "1")
HDtermsubset <- subset(HDsubset, terminationcode == "1")
RMStermsubset <- subset(RMSsubset, terminationcode == "1")
PMStermsubset <- subset(PMSsubset, terminationcode == "1")
Headachetermsubset <- subset(Headachesubset, terminationcode == "1")
Epilepsytermsubset <- subset(Epilepsysubset, terminationcode == "1")
TBItermsubset <- subset(TBIsubset, terminationcode == "1")
Stroketermsubset <- subset(Strokesubset, terminationcode == "1")

#termcount
Overalltermcount <- nrow(Overalltermsubset)
ADtermcount <- nrow(ADtermsubset)
PDtermcount <- nrow(PDtermsubset)
ALStermcount <- nrow(ALStermsubset)
HDtermcount <- nrow(HDtermsubset)
RMStermcount <- nrow(RMStermsubset)
PMStermcount <- nrow(PMStermsubset)
Headachetermcount <- nrow(Headachetermsubset)
Epilepsytermcount <- nrow(Epilepsytermsubset)
TBItermcount <- nrow(TBItermsubset)
Stroketermcount <- nrow(Stroketermsubset)

#termpercent
Overalltermpercent <- (divide_by(Overalltermcount,Totalcount))*100
ADtermpercent <- (divide_by(ADtermcount,ADcount))*100
PDtermpercent <- (divide_by(PDtermcount,PDcount))*100
ALStermpercent <- (divide_by(ALStermcount,ALScount))*100
HDtermpercent <- (divide_by(HDtermcount,HDcount))*100
RMStermpercent <- (divide_by(RMStermcount,RMScount))*100
PMStermpercent <-(divide_by(PMStermcount,PMScount))*100
Headachetermpercent <- (divide_by(Headachetermcount,Headachecount))*100
Epilepsytermpercent <- (divide_by(Epilepsytermcount,Epilepsycount))*100
TBItermpercent <- (divide_by(TBItermcount,TBIcount))*100
Stroketermpercent <- (divide_by(Stroketermcount,Strokecount))*100

##need to use full sample make full sample denominators
#preceded term
Overallpreceedfull <- subset(neurobypass, preceeded == "1")
ADpreceedfull <- subset(ADsubset, preceeded == "1")
PDpreceedfull<- subset(PDsubset, preceeded == "1")
ALSpreceedfull <- subset(ALSsubset, preceeded == "1")
HDpreceedfull <- subset(HDsubset, preceeded == "1")
RMSpreceedfull <- subset(RMSsubset, preceeded == "1")
PMSpreceedfull <- subset(PMSsubset, preceeded == "1")
Headachepreceedfull <- subset(Headachesubset, preceeded == "1")
Epilepsypreceedfull <- subset(Epilepsysubset, preceeded == "1")
TBIpreceedfull <- subset(TBIsubset, preceeded == "1")
Strokepreceedfull <- subset(Strokesubset, preceeded == "1")

Overallpreceedfullcount <- nrow(Overallpreceedfull)
ADpreceedfullcount <- nrow(ADpreceedfull)
PDpreceedfullcount <- nrow(PDpreceedfull)
ALSpreceedfullcount <- nrow(ALSpreceedfull)
HDpreceedfullcount <- nrow(HDpreceedfull)
RMSpreceedfullcount <- nrow(RMSpreceedfull)
PMSpreceedfullcount <- nrow(PMSpreceedfull)
Headachepreceedfullcount <- nrow(Headachepreceedfull)
Epilepsypreceedfullcount <- nrow(Epilepsypreceedfull)
TBIpreceedfullcount <- nrow(TBIpreceedfull)
Strokepreceedfullcount <- nrow(Strokepreceedfull)

#bypassfull sample

Overallbypassandambifull <- subset(neurobypass, preceeded == "0")
ADbypassandambifull <- subset(ADsubset, preceeded == "0")
PDbypassandambifull<- subset(PDsubset, preceeded == "0")
ALSbypassandambifull <- subset(ALSsubset, preceeded == "0")
HDbypassandambifull <- subset(HDsubset, preceeded== "0")
RMSbypassandambifull <- subset(RMSsubset, preceeded == "0")
PMSbypassandambifull <- subset(PMSsubset, preceeded == "0")
Headachebypassandambifull <- subset(Headachesubset, preceeded == "0")
Epilepsybypassandambifull <- subset(Epilepsysubset, preceeded == "0")
TBIbypassandambifull <- subset(TBIsubset, preceeded == "0")
Strokebypassandambifull <- subset(Strokesubset, preceeded == "0")

Overallbypassandambicountfull <- nrow(Overallbypassandambifull)
ADbypassandambicountfull <- nrow(ADbypassandambifull)
PDbypassandambicountfull <- nrow(PDbypassandambifull)
ALSbypassandambicountfull <- nrow(ALSbypassandambifull)
HDbypassandambicountfull <- nrow(HDbypassandambifull)
RMSbypassandambicountfull <- nrow(RMSbypassandambifull)
PMSbypassandambicountfull <- nrow(PMSbypassandambifull)
Headachebypassandambicountfull <- nrow(Headachebypassandambifull)
Epilepsybypassandambicountfull <- nrow(Epilepsybypassandambifull)
TBIbypassandambicountfull <- nrow(TBIbypassandambifull)
Strokebypassandambicountfull <- nrow(Strokebypassandambifull)


#preceded analysis 
Overallpreceedterm <-subset(Overallpreceedfull, terminationcode == "1")
ADprecedterm <- subset(ADpreceedfull, terminationcode == "1")
PDprecedterm<- subset(PDpreceedfull, terminationcode == "1")
ALSprecedterm <- subset(ALSpreceedfull, terminationcode == "1")
HDprecedterm <- subset(HDpreceedfull, terminationcode == "1")
RMSprecedterm <- subset(RMSpreceedfull, terminationcode == "1")
PMSprecedterm <- subset(PMSpreceedfull, terminationcode == "1")
Headacheprecedterm <- subset(Headachepreceedfull, terminationcode == "1")
Epilepsyprecedterm <- subset(Epilepsypreceedfull, terminationcode == "1")
TBIprecedterm <- subset(TBIpreceedfull, terminationcode == "1")
Strokeprecedterm <- subset(Strokepreceedfull, terminationcode == "1")

Overallprectermnumber <- nrow(Overallpreceedterm)
ADprectermnumber <- nrow(ADprecedterm)
PDprectermnumber <- nrow(PDprecedterm)
ALSprectermnumber  <- nrow(ALSprecedterm)
HDprectermnumber  <- nrow(HDprecedterm)
RMSprectermnumber  <- nrow(RMSprecedterm)
PMSprectermnumber  <- nrow(PMSprecedterm)
Headacheprectermnumber  <- nrow(Headacheprecedterm)
Epilepsyprectermnumber  <- nrow(Epilepsyprecedterm)
TBIprectermnumber  <- nrow(TBIprecedterm)
Strokeprectermnumber  <- nrow(Strokeprecedterm)

Overallprecedtermpercent <- (divide_by(Overallprectermnumber,Overallpreceedfullcount))*100
ADprecedtermpercent <- (divide_by(ADprectermnumber,ADpreceedfullcount))*100
PDprecedtermpercent <- (divide_by(PDprectermnumber,PDpreceedfullcount))*100
ALSprecedtermpercent  <- (divide_by(ALSprectermnumber,ALSpreceedfullcount))*100
HDprecedtermpercent <- (divide_by(HDprectermnumber,HDpreceedfullcount))*100
RMSprecedtermpercent <- (divide_by(RMSprectermnumber,RMSpreceedfullcount))*100
PMSprecedtermpercent <- (divide_by(PMSprectermnumber,PMSpreceedfullcount))*100
Headacheprecedtermpercent <- (divide_by(Headacheprectermnumber,Headachepreceedfullcount))*100
Epilepsyprecedtermpercent <- (divide_by(Epilepsyprectermnumber,Epilepsypreceedfullcount))*100
TBIprecedtermpercent <- (divide_by(TBIprectermnumber,TBIpreceedfullcount))*100
Strokeprecedtermpercent  <- (divide_by(Strokeprectermnumber,Strokepreceedfullcount))*100

#bypassterm
Overallbypassterm<-subset(Overallbypassandambifull, terminationcode == "1")
ADbypassterm <- subset(ADbypassandambifull, terminationcode == "1")
PDbypassterm<- subset(PDbypassandambifull, terminationcode == "1")
ALSbypassterm <- subset(ALSbypassandambifull, terminationcode == "1")
HDbypassterm <- subset(HDbypassandambifull, terminationcode == "1")
RMSbypassterm <- subset(RMSbypassandambifull, terminationcode == "1")
PMSbypassterm <- subset(PMSbypassandambifull, terminationcode == "1")
Headachebypassterm <- subset(Headachebypassandambifull, terminationcode == "1")
Epilepsybypassterm <- subset(Epilepsybypassandambifull, terminationcode == "1")
TBIbypassterm <- subset(TBIbypassandambifull, terminationcode == "1")
Strokebypassterm <- subset(Strokebypassandambifull, terminationcode == "1")

Overallbypasstermnumber <- nrow(Overallbypassterm)
ADbypasstermnumber <- nrow(ADbypassterm)
PDbypasstermnumber <- nrow(PDbypassterm)
ALSbypasstermnumber  <- nrow(ALSbypassterm)
HDbypasstermnumber  <- nrow(HDbypassterm)
RMSbypasstermnumber  <- nrow(RMSbypassterm)
PMSbypasstermnumber  <- nrow(PMSbypassterm)
Headachebypasstermnumber  <- nrow(Headachebypassterm)
Epilepsybypasstermnumber  <- nrow(Epilepsybypassterm)
TBIbypasstermnumber  <- nrow(TBIbypassterm)
Strokebypasstermnumber  <- nrow(Strokebypassterm)

Overallbypasstermpercent <- (divide_by(Overallbypasstermnumber,Overallbypassandambicountfull))*100
ADbypasstermpercent <- (divide_by(ADbypasstermnumber,ADbypassandambicountfull))*100
PDbypasstermpercent <- (divide_by(PDbypasstermnumber,PDbypassandambicountfull))*100
ALSbypasstermpercent  <- (divide_by(ALSbypasstermnumber,ALSbypassandambicountfull))*100
HDbypasstermpercent <- (divide_by(HDbypasstermnumber,HDbypassandambicountfull))*100
RMSbypasstermpercent <- (divide_by(RMSbypasstermnumber,RMSbypassandambicountfull))*100
PMSbypasstermpercent <- (divide_by(PMSbypasstermnumber,PMSbypassandambicountfull))*100
Headachebypasstermpercent <- (divide_by(Headachebypasstermnumber,Headachebypassandambicountfull))*100
Epilepsybypasstermpercent <- (divide_by(Epilepsybypasstermnumber,Epilepsybypassandambicountfull))*100
TBIbypasstermpercent <- (divide_by(TBIbypasstermnumber,TBIbypassandambicountfull))*100
Strokebypasstermpercent  <- (divide_by(Strokebypasstermnumber,Strokebypassandambicountfull))*100


Indicationvector1<-c("All Indications","Alzheimer's disease","Parkinson's disease","Amyotrophic lateral sclerosis","Huntington's disease","Relapsing Multiple sclerosis","Progressive multiple sclerosis","Headache","Epilepsy","TBI","Stroke")

PositivityN<- c(Overallposcount,ADposcount,PDposcount,ALSposcount,HDposcount,RMSposcount,PMSposcount,Headacheposcount,Epilepsyposcount,TBIposcount,Strokeposcount)

PositivityRate<- c(Overallpospercent,ADpospercent,PDpospercent,ALSpospercent,HDpospercent,RMSpospercent,PMSpospercent,Headachepospercent,Epilepsypospercent,TBIpospercent,Strokepospercent)

proceedposN <- c(Overallprecposnumber, ADprecposnumber, PDprecposnumber, ALSprecposnumber, HDprecposnumber,RMSprecposnumber,PMSprecposnumber,Headacheprecposnumber,Epilepsyprecposnumber,TBIprecposnumber,Strokeprecposnumber)

proceedthatwerepospercent <- c(Overallprecedpospercent, ADprecedpospercent, PDprecedpospercent, ALSprecedpospercent, HDprecedpospercent,RMSprecedpospercent,PMSprecedpospercent,Headacheprecedpospercent,Epilepsyprecedpospercent,TBIprecedpospercent,Strokeprecedpospercent)

bypassedposN<- c(Overallbypassposnumber,ADbypassposnumber,PDbypassposnumber, ALSbypassposnumber, HDbypassposnumber,RMSbypassposnumber,PMSbypassposnumber,Headachebypassposnumber,Epilepsybypassposnumber,TBIbypassposnumber, Strokebypassposnumber)

bypassedthatwerepospercent<- c(Overallbypasspospercent,ADbypasspospercent,PDbypasspospercent, ALSbypasspospercent, HDbypasspospercent,RMSbypasspospercent,PMSbypasspospercent,Headachebypasspospercent,Epilepsybypasspospercent, TBIbypasspospercent, Strokebypassposnumber)

TerminationN<- c(Overalltermcount,ADtermcount,PDtermcount,ALStermcount,HDtermcount,RMStermcount,PMStermcount,Headachetermcount,Epilepsytermcount,TBItermcount,Stroketermcount)

TerminationRate<-c(Overalltermpercent,ADtermpercent,PDtermpercent,ALStermpercent,HDtermpercent,RMStermpercent,PMStermpercent,Headachetermpercent,Epilepsytermpercent,TBItermpercent,Stroketermpercent)

proceedtermN <- c(Overallprectermnumber, ADprectermnumber,PDprectermnumber, ALSprectermnumber, HDprectermnumber, RMSprectermnumber, PMSprectermnumber, Headacheprectermnumber, Epilepsyprectermnumber, TBIprectermnumber, Strokeprectermnumber)

proceedthatweretermpercent <- c(Overallprecedtermpercent, ADprecedtermpercent,PDprecedtermpercent, ALSprecedtermpercent, HDprecedtermpercent, RMSprecedtermpercent, PMSprecedtermpercent, Headacheprecedtermpercent, Epilepsyprecedtermpercent, TBIprecedtermpercent, Strokeprecedtermpercent)

bypassedtermN<- c(Overallbypasstermnumber,ADbypasstermnumber,PDbypasstermnumber, ALSbypasstermnumber, HDbypasstermnumber,RMSbypasstermnumber,PMSbypasstermnumber,Headachebypasstermnumber,Epilepsybypasstermnumber, TBIbypasstermnumber, Strokebypasstermnumber)

bypassedthatweretermpercent<- c(Overallbypasstermpercent,ADbypasstermpercent,PDbypasstermpercent, ALSbypasstermpercent, HDbypasstermpercent,RMSbypasstermpercent,PMSbypasstermpercent,Headachebypasstermpercent,Epilepsybypasstermpercent, TBIbypasstermpercent, Strokebypasstermpercent)

positivityandtermtable <- data.frame(Indication=rep(Indicationvector1),
                 Positivity_N=rep(PositivityN),                 
                 Positivity_Rate=rep(PositivityRate),
                 PrecPositivity_N =rep(proceedposN),
                 Positivity_Rate_when_proceeded_by_P2=rep(proceedthatwerepospercent),
                 BypassPositivity_N =rep(bypassedposN),
                 Positivity_Rate_when_bypassed=rep(bypassedthatwerepospercent),
                 Termination_N=rep(TerminationN), 
                 Termination_Rate=rep(TerminationRate),
                 PrecTermination_N=rep(proceedtermN),
                 Termination_Rate_when_proceeded=rep(proceedthatweretermpercent),
                 BypassTermination_N=rep(bypassedtermN),
                 Termination_Rate_when_bypassed=rep(bypassedthatweretermpercent)
                 )

print(positivityandtermtable)
write.table(positivityandtermtable)

```


```{r, echo=FALSE, message = FALSE, warning=FALSE, include=FALSE}
#for SMD&for WdAe
#Patient benefit was analyzed with a random-effects meta-analysis comparing the standardized mean difference (SMD)29 in change from baseline between the treatment and placebo arms within each indication. All measures of variance were converted to SDs using the methods outlined in the Cochrane Handbook,30 and multiple treatment arms in the same trial were pooled using inverse variance weighting.31 Patient risk was analyzed with random-effects meta-analyses to calculate risk ratios (RRs) of SAEs and WAEs between the treatment and placebo arms. A correction factor of 0.5 was added to SAE and WAE values for trials that reported zero event rates in both arms to allow these trials to contribute to the overall pooled effect size and confidence intervals (CIs).33 

#It should be noted that the SMD method does not correct for differences in the direction of the scale. If some scales increase with disease severity (for example, a higher score indicates more severe depression) whilst others decrease (a higher score indicates less severe depression), it is essential to multiply the mean values from one set of studies by –1 (or alternatively to subtract the mean from the maximum possible value for the scale) to ensure that all the scales point in the same direction, before standardization. Any such adjustment should be described in the statistical methods section of the review. The SD does not need to be modified.

#seperate into indications-only these are included for now--check again when new data is added
#Alzheimer’s disease, Parkinson’s disease, Migraine
#check other indications 

SMDsubset <- subset(neurobypass, Is_there_a_SMD == "1")

SMDsubset$Mean_difference = as.numeric(as.character(SMDsubset$Mean_difference)) 
SMDsubset$p_value = as.numeric(as.character(SMDsubset$p_value))
SMDsubset$upperCI = as.numeric(as.character(SMDsubset$upperCI)) 
SMDsubset$lowerCI = as.numeric(as.character(SMDsubset$lowerCI))
SMDsubset$preceeded <- factor(SMDsubset$preceeded, 
                                     labels = c("Bypassed",
                                                  "Did not bypass"))
SMDsubset <- SMDsubset %>%
  mutate(SMD_SE = case_when((variance_type=="95" ~ (abs((upperCI)-(lowerCI)))/(abs(qnorm((1-0.95)/2))*2)),
                  (variance_type=="not95" ~  abs((Mean_difference)/qnorm(p_value/2)))))

ADsubsetSMD <- subset(SMDsubset, indication == "AD")
 

ADSMDpooling <- metagen(
  TE=Mean_difference,
  seTE=SMD_SE,
  data = ADsubsetSMD,
  sm = "SMD",
  comb.fixed = FALSE,
  comb.random = TRUE,
  subgroup = preceeded,
  random = T,
  fixed = F,
  tau.common = F,
  method.tau = "SJ", # # "DL", "PM", "REML", "ML", "HS", "SJ", "HE", or "EB"
)
summary(ADSMDpooling)

#wdAE

WdAEsubset <- subset(neurobypass, Is_there_a_WDAE == "1")


WdAEsubset$withdrawals_in_exparm = as.numeric(as.character(WdAEsubset$withdrawals_in_exparm)) 
WdAEsubset$Nexp_arm = as.numeric(as.character(WdAEsubset$Nexp_arm)) 
WdAEsubset$withdrawals_in_contarm = as.numeric(as.character(WdAEsubset$withdrawals_in_contarm)) 
WdAEsubset$Ncont_arm = as.numeric(as.character(WdAEsubset$Ncont_arm)) 

WdAEsubset$preceeded <- factor(WdAEsubset$preceeded, 
                                     labels = c("Bypassed",
                                                  "Did not bypass"))
TotalwdAE <-metabin(
  event.e=withdrawals_in_exparm,
  n.e=Nexp_arm,
  event.c=withdrawals_in_contarm,
  n.c=Ncont_arm,
  studlab = nct_id,
  data = WdAEsubset, 
  subgroup = preceeded,
  comb.fixed = FALSE,
  fixed = F,
  random = T,
  method.tau = "PM", 
  adhoc.hakn = "se",
)
  
ADsubsetWdAE <- subset(WdAEsubset, indication == "AD")
PDsubsetWdAE <- subset(WdAEsubset, indication == "PD")
ALSsubsetWdAE <- subset(WdAEsubset, indication == "ALS")
HeadachesubsetWdAE <- subset(WdAEsubset, indication == "Headache")

ADwdAEpooling <- metabin(
  event.e=withdrawals_in_exparm,
  n.e=Nexp_arm,
  event.c=withdrawals_in_contarm,
  n.c=Ncont_arm,
  studlab = nct_id,
  data = ADsubsetWdAE, 
  subgroup = preceeded,
  comb.fixed = FALSE,
  fixed = F,
  random = T,
  method.tau = "PM", 
  adhoc.hakn = "se",
)
summary (ADwdAEpooling)

PDwdAEpooling <- metabin(
  event.e=withdrawals_in_exparm,
  n.e=Nexp_arm,
  event.c=withdrawals_in_contarm,
  n.c=Ncont_arm,
  studlab = nct_id,
  data = PDsubsetWdAE, 
  subgroup = preceeded,
  comb.fixed = FALSE,
  fixed = F,
  random = T,
  method.tau = "PM", 
  adhoc.hakn = "se",
)
summary (PDwdAEpooling)

ALSwdAEpooling <- metabin(
  event.e=withdrawals_in_exparm,
  n.e=Nexp_arm,
  event.c=withdrawals_in_contarm,
  n.c=Ncont_arm,
  studlab = nct_id,
  data = ALSsubsetWdAE, 
  subgroup = preceeded,
  comb.fixed = FALSE,
  fixed = F,
  random = T,
  method.tau = "PM", 
  adhoc.hakn = "se",
)
summary(ALSwdAEpooling)

HeadachewdAEpooling <- metabin(
  event.e=withdrawals_in_exparm,
  n.e=Nexp_arm,
  event.c=withdrawals_in_contarm,
  n.c=Ncont_arm,
  studlab = nct_id,
  data = HeadachesubsetWdAE, 
  subgroup = preceeded,
  comb.fixed = FALSE,
  fixed = F,
  random = T,
  method.tau = "PM", 
  adhoc.hakn = "se",
)
summary (HeadachewdAEpooling)

#forestplots
labels1 <- c("Preceded", "Bypass")
labels2 <- c("PD", "Alzheimer's disease")
labels3 <- c("All Indications1","All Indications")

smdnb <- metabind(ADSMDpooling,ADSMDpooling, name = labels2)
waenb <- metabind(TotalwdAE, TotalwdAE, name = labels3)

pdf("SMD.pdf",10,8)
forest(smdnb, xlim=c(-1,.5), print.subgroup.labels = T,label.left =              "<-------------
Treatment Advantage",label.right = "--------->
Comparator Advantage",)
dev.off()

pdf("WdAeall.pdf",10,8)
forest(waenb, xlim=c(0.25,2.5), print.subgroup.labels = T,label.left =              "<---------
Favours exp arm", label.right = "------------>
Favours control arm")
dev.off()

```


```{r, echo=FALSE, message = FALSE, warning=FALSE, include=FALSE}
# #Fishertests
# #stroke has no preceded so it cant be included
# ###TERMINATION PVALUES
# 
# Overalltermfisher <- prop.test((x = c(Overallprectermnumber,Overallbypasstermnumber)), (n = c(Overallpreceedfullcount,Overallbypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# ADtermfisher <-  prop.test((x = c(ADprectermnumber,ADbypasstermnumber)), (n = c(ADpreceedfullcount,ADbypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# PDtermfisher <-  prop.test((x = c(PDprectermnumber,PDbypasstermnumber)), (n = c(PDpreceedfullcount,PDbypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# ALStermfisher <-  prop.test((x = c(ALSprectermnumber,ALSbypasstermnumber)), (n = c(ALSpreceedfullcount,ALSbypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# HDtermfisher <- prop.test((x = c(HDprectermnumber,HDbypasstermnumber)), (n = c(HDpreceedfullcount,HDbypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# RMStermfisher <- prop.test((x = c(RMSprectermnumber,RMSbypasstermnumber)), (n = c(RMSpreceedfullcount,RMSbypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# PMStermfisher<-  prop.test((x = c(PMSprectermnumber,PMSbypasstermnumber)), (n = c(PMSpreceedfullcount,PMSbypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# Headachetermfisher<- prop.test((x = c(Headacheprectermnumber,Headachebypasstermnumber)), (n = c(Headachepreceedfullcount,Headachebypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# Epilepsytermfisher <-  prop.test((x = c(Epilepsyprectermnumber,Epilepsybypasstermnumber)), (n = c(Epilepsypreceedfullcount,Epilepsybypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# TBItermfisher <-  prop.test((x = c(TBIprectermnumber,TBIbypasstermnumber)), (n = c(TBIpreceedfullcount,TBIbypassandambicountfull)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# 
# ###POSITIVITY PVALUES
# Overallposfisher <- prop.test((x = c(Overallprecposnumber,Overallbypassposnumber)), (n = c(Overallpreceedcount,Overallbypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# ADposfisher <-  prop.test((x = c(ADprecposnumber,ADbypassposnumber)), (n = c(ADpreceedcount,ADbypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# PDposfisher <-  prop.test((x = c(PDprecposnumber,PDbypassposnumber)), (n = c(PDpreceedcount,PDbypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# ALSposfisher <-  prop.test((x = c(ALSprecposnumber,ALSbypassposnumber)), (n = c(ALSpreceedcount,ALSbypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# HDposfisher <-  prop.test((x = c(HDprecposnumber,HDbypassposnumber)), (n = c(HDpreceedcount,HDbypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# RMSposfisher <- prop.test((x = c(RMSprecposnumber,RMSbypassposnumber)), (n = c(RMSpreceedcount,RMSbypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# PMSposfisher<-  prop.test((x = c(PMSprecposnumber,PMSbypassposnumber)), (n = c(PMSpreceedcount,PMSbypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# Headacheposfisher<- prop.test((x = c(Headacheprecposnumber,Headachebypassposnumber)), (n = c(Headachepreceedcount,Headachebypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# Epilepsyposfisher <-  prop.test((x = c(Epilepsyprecposnumber,Epilepsybypassposnumber)), (n = c(Epilepsypreceedcount,Epilepsybypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# TBIposfisher <-  prop.test((x = c(TBIprecposnumber,TBIbypassposnumber)), (n = c(TBIpreceedcount,TBIbypassandambicount)), p = NULL, alternative ="two.sided",correct = TRUE)
# 
# 
# Overalltermpvalue <- Overalltermfisher$p.value
# ADtermpvalue <- ADtermfisher$p.value
# PDtermpvalue <- PDtermfisher$p.value
# ALStermpvalue <- ALStermfisher$p.value
# HDtermpvalue <- HDtermfisher$p.value
# RMStermpvalue <- RMStermfisher$p.value
# PMStermpvalue<- PMStermfisher$p.value
# Headachetermpvalue<- Headachetermfisher$p.value
# Epilepsytermpvalue <- Epilepsytermfisher$p.value
# TBItermpvalue <- TBItermfisher$p.value
# 
# 
# Overallpospvalue <- Overallposfisher$p.value
# ADpospvalue <- ADposfisher$p.value
# PDpospvalue <- PDposfisher$p.value
# ALSpospvalue <- ALSposfisher$p.value
# HDpospvalue <- HDposfisher$p.value
# RMSpospvalue <- RMSposfisher$p.value
# PMSpospvalue<- PMSposfisher$p.value
# Headachepospvalue<- Headacheposfisher$p.value
# Epilepsypospvalue <- Epilepsyposfisher$p.value
# TBIpospvalue <- TBIposfisher$p.value
# 
# Indicationvector2<-c("All Indications","Alzheimer's disease","Parkinson's disease","Amyotrophic lateral sclerosis","Huntington's disease","Relapsing Multiple sclerosis","Progressive multiple sclerosis","Headache","Epilepsy","TBI")
# 
# pospvalues<- c(Overallpospvalue, ADpospvalue, PDpospvalue, ALSpospvalue, HDpospvalue, RMSpospvalue, PMSpospvalue, Headachepospvalue, Epilepsypospvalue, TBIpospvalue)
# 
# termpvalues <- c(Overalltermpvalue, ADtermpvalue, PDtermpvalue, ALStermpvalue, HDtermpvalue, RMStermpvalue, PMStermpvalue, Headachetermpvalue, Epilepsytermpvalue, TBItermpvalue)
#  
# pvalues <- data.frame(Indication=rep(Indicationvector2),
#                  Positivity_pvalues=rep(pospvalues),                 
#                  Termination_pvalues=rep(termpvalues))
# write.table(pvalues)
      
```


```{r, echo=FALSE, message = FALSE, warning=FALSE, include=FALSE}
#positivity when looking at diff definition of bypassing 
#for positivity
#PROCEEDED
#proceededpos
Overallpreceednew <- subset(Overallhasresults, preceeded == "1")
Overallpreceedcountnew <- nrow(Overallpreceednew)

Overallprecedposnew <- subset(Overallpreceednew, positivityofP3 == "Positive")
Overallprecposnumbernew <-nrow(Overallprecedposnew)
Overallprecedpospercentnew <- (divide_by(Overallprecposnumbernew,Overallpreceedcountnew))*100

#Ambigious overall
Overallambinew <- subset(Overallhasresults, Ambigious == "1")
Overallambicountnew <- nrow(Overallambinew)

Overallambiposnew <- subset(Overallambinew, positivityofP3 == "Positive")
Overallambiposnumbernew <-nrow(Overallambiposnew)
Overallambipospercentnew <- (divide_by(Overallambiposnumbernew,Overallambicountnew))*100

#ambigNonpos
Overallambinewnp <- subset(Overallhasresults, Nonpositive == "1")
Overallambicountnewnp <- nrow(Overallambinewnp)

Overallambiposnewnp <- subset(Overallambinewnp, positivityofP3 == "Positive")
Overallambiposnumbernewnp <-nrow(Overallambiposnewnp)
Overallambipospercentnewnp <- (divide_by(Overallambiposnumbernewnp,Overallambicountnewnp))*100

#ambigbadendpoint
Overallambinewbad <- subset(Overallhasresults, bad_endpoint == "1")
Overallambicountnewbad <- nrow(Overallambinewbad)

Overallambiposnewbad <- subset(Overallambinewbad, positivityofP3 == "Positive")
Overallambiposnumbernewbad <-nrow(Overallambiposnewbad)
Overallambipospercentnewbad <- (divide_by(Overallambiposnumbernewbad,Overallambicountnewbad))*100

#BYPASS
Overallbypass <- subset(Overallhasresults, Truebypass == "1")
Overallbypasscount<- nrow(Overallbypass)

Overallbypassposnew <- subset(Overallbypass, positivityofP3 == "Positive")
Overallbypassposnumbernew <- nrow(Overallbypassposnew)
Overallbypasspospercentnew <-(divide_by(Overallbypassposnumbernew,Overallbypasscount))*100


#TERMINATION

#termpercent
##need to use full sample make full sample denominators
#preceded term
Overallpreceedfullnew <- subset(neurobypass, preceeded == "1")
Overallpreceedfullcountnew <- nrow(Overallpreceedfullnew)

#ambifull sample
Overallambifullnew <- subset(neurobypass, Ambigious == "1")
Overallambifullcountnew <- nrow(Overallambifullnew)

Overallambifullnewnp <- subset(neurobypass, Nonpositive == "1")
Overallambifullcountnewnp <- nrow(Overallambifullnewnp)

Overallambifullnewbad <- subset(neurobypass, bad_endpoint == "1")
Overallambifullcountnewbad <- nrow(Overallambifullnewbad)

#bypassfull sample
Overallbypassfull <- subset(neurobypass, Truebypass == "1")
Overallbypasscountfullnew <- nrow(Overallbypassfull)

#preceded analysis 
Overallpreceedtermnew <-subset(Overallpreceedfullnew, terminationcode == "1")
Overallprectermnumbernew <- nrow(Overallpreceedtermnew)
Overallprecedtermpercentnew <- (divide_by(Overallprectermnumbernew,Overallpreceedfullcountnew))*100

#ambi analyisis
Overallambitermnew <-subset(Overallambifullnew, terminationcode == "1")
Overallambitermnumbernew <- nrow(Overallambitermnew)
Overallambitermpercentnew <- (divide_by(Overallambitermnumbernew,Overallambifullcountnew))*100

Overallambitermnewnp <-subset(Overallambifullnewnp, terminationcode == "1")
Overallambitermnumbernewnp <- nrow(Overallambitermnewnp)
Overallambitermpercentnewnp <- (divide_by(Overallambitermnumbernewnp,Overallambifullcountnewnp))*100

Overallambitermnewbad <-subset(Overallambifullnewbad, terminationcode == "1")
Overallambitermnumbernewbad <- nrow(Overallambitermnewbad)
Overallambitermpercentnewbad <- (divide_by(Overallambitermnumbernewbad,Overallambifullcountnewbad))*100

#bypassterm
Overallbypasstermnew<-subset(Overallbypassfull, terminationcode == "1")
Overallbypasstermnumbernew <- nrow(Overallbypasstermnew)
Overallbypasstermpercentnew <- (divide_by(Overallbypasstermnumbernew,Overallbypasscountfullnew))*100

Indicationvector3<-c("Preceded ","Ambi","NP","bad","Term")
Positivitynumber<-c(Overallprecposnumbernew,Overallambiposnumbernew,Overallambiposnumbernewnp,Overallambiposnumbernewbad,Overallbypassposnumbernew)
PositivityRatecolumn<-c(Overallprecedpospercentnew,Overallambipospercentnew,Overallambipospercentnewnp,Overallambipospercentnewbad,Overallbypasspospercentnew)
Terminationnumber<-c(Overallprectermnumbernew,Overallambitermnumbernew,Overallambitermnumbernewnp,Overallambitermnumbernewbad,Overallbypasstermnumbernew)
TerminationRatecolumn<-c(Overallprecedtermpercentnew,Overallambitermpercentnew,Overallambitermpercentnewnp,Overallambitermpercentnewbad,Overallbypasstermpercentnew)

Indicationvector4<-c("Positivity Rate","Termination Rate")
Precedednumb<-c(Overallprecposnumbernew,Overallprectermnumbernew)
Precededdenom<-c(Overallpreceedcountnew,Overallpreceedfullcountnew)
Precededrate<-c(Overallprecedpospercentnew,Overallprecedtermpercentnew)
Negnumb<-c(Overallambiposnumbernewnp,Overallambitermnumbernewnp)
Negdenom<-c(Overallambicountnewnp,Overallambifullcountnewnp)
Negrate<-c(Overallambipospercentnewnp,Overallambitermpercentnewnp)
NAnumb<-c(Overallambiposnumbernewbad,Overallambitermnumbernewbad)
NAdenom<-c(Overallambicountnewbad,Overallambifullcountnewbad)
NArate<-c(Overallambipospercentnewbad,Overallambitermpercentnewbad)
TBnumb<-c(Overallbypassposnumbernew,Overallbypasstermnumbernew)
TBdenom<-c(Overallbypasscount,Overallbypasscountfullnew)
TBrate<-c(Overallbypasspospercentnew,Overallbypasstermpercentnew)

positivityandtermboth2 <- data.frame(Indication=rep(Indicationvector4),
                                    Precedednumbers=rep(Precedednumb),
                                    Precededdenominator=rep(Precededdenom),
                                    Precededrates=rep(Precededrate),
                                    Negativenumb=rep(Negnumb),
                                    Negdenominator=rep(Negdenom),
                                    Negativerate=rep(Negrate),
                                    NAnumber=rep(NAnumb),
                                    NAPrecededdenominator=rep(NAdenom),
                                    NArates=rep(NArate),
                                    TBnumber=rep(TBnumb),
                                    TBdenominator=rep(TBdenom),
                                    TBrates=rep(TBrate))

write.table(positivityandtermboth2)
table1 <- table(neurobypass$terminationcode, neurobypass$preceeded)
table1
Overalltermfisher <- fisher.test(table(neurobypass$terminationcode, neurobypass$preceeded))
Overallposfisher <- fisher.test(table(Overallhasresults$positivityofP3, Overallhasresults$preceeded))
Overalltermpvalue <- Overalltermfisher$p.value
Overallpospvalue <- Overallposfisher$p.value
Overallpospvalue
Overalltermpvalue
#Overalltermfisher2 <- prop.test((x = c(Overallprectermnumbernew,Overallbypasstermnumbernew)), (n = c(Overallpreceedfullcountnew,Overallbypasscountfullnew)), p = NULL, alternative ="two.sided",correct = TRUE)
#Overallposfisher2 <- prop.test((x = c(Overallprecposnumbernew,Overallbypassposnumbernew)), (n = c(Overallpreceedcountnew,Overallbypasscountfullnew)), p = NULL, alternative ="two.sided",correct = TRUE)
#Overalltermpvalue2 <- Overalltermfisher2$p.value
#Overallpospvalue2 <- Overallposfisher2$p.value
#pvaluespos<-c(Overallpospvalue,Overallpospvalue2)
#pvaluesterm<-c(Overalltermpvalue,Overalltermpvalue2)
table(neurobypass$terminationcode, neurobypass$preceeded)

#sensitivity analysis 
OverallpreceedSA <- subset(Overallhasresults, preceeded == "1")
OverallpreceednewSA <- subset(OverallpreceedSA, preceeded == "1")
OverallpreceedcountnewSA <- nrow(Overallpreceednew)

OverallprecedposnewSA <- subset(OverallpreceednewSA, positivityofP3 == "Positive")
OverallprecposnumbernewSA <-nrow(OverallprecedposnewSA)
OverallprecedpospercentnewSA <- (divide_by(OverallprecposnumbernewSA,OverallpreceedcountnewSA))*100

OverallnewSA <- subset(OverallpreceedSA, preceeded == "1")
OverallpreceedcountnewSA <- nrow(Overallpreceednew)

OverallprecedposnewSA <- subset(OverallpreceednewSA, positivityofP3 == "Positive")
OverallprecposnumbernewSA <-nrow(OverallprecedposnewSA)
OverallprecedpospercentnewSA <- (divide_by(OverallprecposnumbernewSA,OverallpreceedcountnewSA))*100

OverallnewSA <- subset(Overallhasresults, sens == "1")
table1<-table(OverallnewSA$positivityofP3, OverallnewSA$preceeded)
table1
OverallposfisherSA <- fisher.test(table(OverallnewSA$positivityofP3, OverallnewSA$preceeded))
summary(OverallposfisherSA)
OverallpospvalueSA <- OverallposfisherSA$p.value
OverallpospvalueSA

table(neurobypass$degenerative, neurobypass$preceeded)
Overallfisherdegen <- fisher.test(table(neurobypass$degenerative, neurobypass$preceeded))
summary(Overallfisherdegen)
Overallfisherdegenp <- Overallfisherdegen$p.value
Overallfisherdegenp
```


```{r, echo=FALSE, message = FALSE, warning=FALSE, include=FALSE}
#patientnumbers and timing
library(tidyverse)

nctids <- read_csv("nctsforenrollment.csv") %>%
    select(nct_id)

nctids_string <- pull(nctids) %>%
    paste(collapse="%20OR%20")

trials <- read_csv(paste0("https://clinicaltrials.gov/ct2/results/download_fields?down_count=10000&down_flds=all&down_fmt=csv&term=", nctids_string, "&flds=a&flds=b&flds=g&flds=o&flds=u"))

trials <- trials %>%
    mutate(found = `NCT Number` %in% nctids$nct_id) %>%
    filter(found) %>%
    select(! found)
trials %>%
    write_csv("~/Projects/Neurobypass/2023-01-25-hannah-trial-data.csv")

summary(neurobypass$Enrollment)
summary(neurobypass$time_difference) 

Onlyphase3<-subset(neurobypass, phase== "Phase_3")

#need to add positivity from overall document
Onlyphase3nonpos<-subset(Onlyphase3, positivityofP3!="Positive")
summary(Onlyphase3nonpos$Enrollment)
summary(Onlyphase3nonpos$time_difference)


Onlyphase3term<-subset(Onlyphase3, terminationcode=="1")
summary(Onlyphase3term$Enrollment)
summary(Onlyphase3term$time_difference)

#hist bypass over time 
library(tidyverse)
library(ggplot2)
library(lubridate)
library(xml2)

data(neurobypass)
#need to make bins into years
pdf("overtime.pdf", width=12, height=6)
ggplot(
    aes(
        x = Startdate,
        #need to change to bypass
        y = preceeded
    ),
    data = neurobypass
) +
    geom_histogram(
        position = "stack",
        binwidth = 7
    ) +
    scale_x_date(
        limits = c("2010-12-01","2021-12-30"),
        minor_breaks = "1 year"
    ) +
    scale_fill_manual(
        values = c(
            "grey",
            "#026B34"
        ),
    ) +
    labs(
        x = "Start date",
        y = "Number of trials bypassing",
        fill = "Why stopped",
        title = paste(
            "Trials that stopped per week during the first three",
        )
    ) +
    theme(
        legend.position = "bottom"
    )
dev.off()

```
#write text 
#write variables 
Results Section 

Sample
After applying our inclusion criteria to the downloaded trials, **`r round(Totalcount, 2)`** trials were included in our analysis. Of these trials, **`r round(ADcount, 2)`** trials were in Alzheimer's disease", **`r round(PDcount, 2)`** Parkinson disease,**`r round(ALScount, 2)`** Amyotrophic lateral sclerosis, **`r round(HDcount, 2)`** Huntingtons disease,**`r round(MScount, 2)`** Multiple sclerosis ,**`r round(Migrainecount, 2)`** Migraine,**`r round(Headachecount, 2)`** Headache,**`r round(Epilepsycount, 2)`** Epilepsy,**`r round(TBIcount, 2)`** TBI ,**`r round(Strokecount, 2)`** Stroke. The average sample size was x and x (TABLE 1). 

Prevalence
In our sample, we found that **`r round(Totalpreceededcount, 2)`** were proceeded by a positive P2 trial ,**`r round(Totalambigiouscount, 2)`** were preceded by ambigious evidence, and **`r round(Totalbypasscount, 2)`** lacked any prior evidence that fulfilled our criteria. Overall positivity numbers? Prevalence of bypassing and P3 positivity is broken down into disease areas in Table 1.  Compare indications 